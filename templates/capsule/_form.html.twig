{{ form_start(form) }}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="soft-card p-4 p-md-5">

            <div class="text-center mb-5">
                <div class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle mb-3 shadow-sm" style="width: 60px; height: 60px;">
                    <i class="fas fa-paper-plane fa-lg"></i>
                </div>
                <h3 class="fw-bold">Mission Temporelle</h3>
            </div>

            <div class="form-floating mb-4">
                {{ form_widget(form.title, {'attr': {'class': 'form-control bg-light border-0 shadow-sm', 'placeholder': 'Titre'}}) }}
                {{ form_label(form.title, 'Titre') }}
                <div class="form-text text-danger">{{ form_errors(form.title) }}</div>
            </div>

            <div class="form-floating mb-4">
                {{ form_widget(form.content, {'attr': {'class': 'form-control bg-light border-0 shadow-sm', 'style': 'height: 150px', 'placeholder': 'Message'}}) }}
                {{ form_label(form.content, 'Message...') }}
                <div class="form-text text-danger">{{ form_errors(form.content) }}</div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted text-uppercase ms-1">Date d'ouverture</label>
                    {{ form_widget(form.sendDate, {'attr': {'class': 'form-control border-0 bg-light p-3'}}) }}
                </div>

                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted text-uppercase ms-1">Pour qui ?</label>
                    <div class="input-group shadow-sm rounded-3 overflow-hidden">
                        <span class="input-group-text border-0 bg-white text-primary"><i class="fas fa-at"></i></span>
                        {{ form_widget(form.targetEmail, {'attr': {'class': 'form-control border-0 bg-light', 'value': form.targetEmail.vars.value is not empty ? form.targetEmail.vars.value : app.user.email }}) }}
                    </div>
                </div>
            </div>

            <div class="mb-5">
                <label class="form-label small fw-bold text-muted text-uppercase ms-1">Photo Souvenir</label>

                <div class="p-3 rounded-4 border-2 border-dashed bg-light position-relative text-center hover-effect overflow-hidden" id="drop-zone" style="min-height: 150px; display: flex; align-items: center; justify-content: center; flex-direction: column;">

                    <img id="image-preview" src="#" alt="Aperçu" class="d-none img-fluid rounded-3 shadow-sm mb-3" style="max-height: 200px;">

                    {# Attention: Assure-toi que la variable s'appelle bien imageFilename dans ton entité #}
                    {% if form.vars.value.imageFilename is defined and form.vars.value.imageFilename %}
                        <div id="current-image-container" class="mb-3 position-relative">
                             <img src="{{ asset('uploads/' ~ form.vars.value.imageFilename) }}" class="img-fluid rounded-3 shadow-sm" style="max-height: 200px;" alt="Image actuelle">
                             <div class="badge bg-primary position-absolute top-0 start-0 m-2">Actuelle</div>
                        </div>
                    {% endif %}

                    <div id="upload-placeholder" class="{{ (form.vars.value.imageFilename is defined and form.vars.value.imageFilename) ? 'd-none' : '' }}">
                        <i class="fas fa-camera text-secondary mb-2 fs-3"></i>
                        <span class="small text-muted d-block fw-bold">Cliquez pour choisir une photo</span>
                    </div>

                    {{ form_widget(form.imageFile, {'attr': {'class': 'form-control opacity-0 position-absolute top-0 start-0 w-100 h-100', 'style': 'cursor: pointer;', 'onchange': 'previewImage(this)' }}) }}
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center pt-3 border-top gap-3">
                <a href="{{ path('app_capsule_index') }}" class="btn btn-outline-secondary rounded-pill px-4 fw-bold">
                    <i class="fas fa-arrow-left me-2"></i> Retour
                </a>
                <button class="btn btn-primary rounded-pill px-5 py-3 shadow fw-bold transition-3d flex-grow-1 flex-md-grow-0">
                    <i class="fas fa-envelope-open-text me-2"></i> Sceller
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .border-dashed { border-style: dashed !important; border-color: #cbd5e1; transition: all 0.3s; }
    .form-control:focus { box-shadow: none; border: 1px solid var(--primary); background: white !important; }
    .hover-effect:hover { background: #eef2ff !important; border-color: var(--primary) !important; }
</style>

<script>
    function previewImage(input) {
        const preview = document.getElementById('image-preview');
        const placeholder = document.getElementById('upload-placeholder');
        const currentContainer = document.getElementById('current-image-container'); // L'ancienne image

        if (input.files && input.files[0]) {
            const reader = new FileReader();

            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('d-none'); // On affiche la nouvelle
                placeholder.classList.add('d-none'); // On cache le texte
                if(currentContainer) currentContainer.classList.add('d-none'); // On cache l'ancienne image si elle existe
            }

            reader.readAsDataURL(input.files[0]);
        }
    }
</script>

{{ form_end(form) }}
